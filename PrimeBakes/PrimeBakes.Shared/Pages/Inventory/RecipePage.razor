@page "/inventory/recipe"

@using PrimeBakesLibrary.Models.Common;
@using PrimeBakesLibrary.Models.Inventory;
@using PrimeBakesLibrary.Models.Sales.Product

<PageTitle>Recipe - Prime Bakes</PageTitle>

@if (_isLoading)
{
	<SfSpinner @bind-Visible="_isLoading" Label="Page is Loading, Please Wait" />
}
else
{
	<PageHeader Title="Product Recipe Management" Subtitle="Create and manage product recipes with raw material quantities" ShowHome="true" ShowBack="true" OnHomeClick="@(() => NavigationManager.NavigateTo(PageRouteNames.Dashboard))" OnBackClick="@(() => NavigationManager.NavigateTo(PageRouteNames.InventoryDashboard))">
		<RightContent>
			<button class="btn-icon btn-icon-save" @onclick="OnSaveButtonClick" disabled="@_isProcessing"
				title="Save Recipe">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
					<polyline points="17 21 17 13 7 13 7 21" />
					<polyline points="7 3 7 8 15 8" />
				</svg>
			</button>
			@if (_recipe is not null && _recipe.Id > 0)
			{
				<button class="btn-icon btn-icon-delete" @onclick="DeleteRecipe" disabled="@_isProcessing"
					title="Delete Recipe">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<polyline points="3 6 5 6 21 6" />
						<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
						<line x1="10" y1="11" x2="10" y2="17" />
						<line x1="14" y1="11" x2="14" y2="17" />
					</svg>
				</button>
			}
			<button class="btn-icon" @onclick="ResetPage" disabled="@_isProcessing" title="New Recipe">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="12" y1="5" x2="12" y2="19" />
					<line x1="5" y1="12" x2="19" y2="12" />
				</svg>
			</button>
		</RightContent>
	</PageHeader>

	<!-- Main Content Container -->
	<div class="purchase-container">

		<!-- Product Selection Section -->
		<div class="section-card">
			<div class="section-header">
				<div class="section-title-wrapper">
					<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
						fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="12" cy="12" r="10" />
						<line x1="2" y1="12" x2="22" y2="12" />
						<path
							d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
					</svg>
					<h2 class="section-title">Select Product</h2>
				</div>
			</div>
			<div class="section-body">
				<div class="form-grid-single">
					<div class="form-field form-field-full">
						<label class="field-label">
							Product <span class="required">*</span>
						</label>
						<SfAutoComplete Value="@_selectedProduct" TValue="ProductLocationOverviewModel"
							TItem="ProductLocationOverviewModel" DataSource="@_products" Placeholder="Select a Product"
							FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
							FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" CssClass="custom-autocomplete">
							<AutoCompleteEvents TItem="ProductLocationOverviewModel" TValue="ProductLocationOverviewModel"
								ValueChange="OnProductChanged" />
							<AutoCompleteFieldSettings Value="Name" />
						</SfAutoComplete>
					</div>
				</div>
			</div>
		</div>

		<!-- Add Raw Material to Recipe Section -->
		<div class="section-card">
			<div class="section-header">
				<div class="section-title-wrapper">
					<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
						fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="9" cy="21" r="1" />
						<circle cx="20" cy="21" r="1" />
						<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
					</svg>
					<h2 class="section-title">Add Raw Material to Recipe</h2>
				</div>
			</div>
			<div class="section-body">
				<!-- Single Row: Raw Material and Quantity -->
				<div class="cart-row">
					<div class="cart-field cart-field-product">
						<label class="cart-label">Raw Material <span class="required">*</span></label>
						<SfAutoComplete @ref="_sfItemAutoComplete" @bind-Value="@_selectedRawMaterial"
							TValue="RawMaterialModel ?" TItem="RawMaterialModel" DataSource="@_rawMaterials"
							Placeholder="Select Raw Material" FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
							FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" CssClass="custom-autocomplete">
							<AutoCompleteFieldSettings Value="Name" />
						</SfAutoComplete>
					</div>

					<div class="cart-field cart-field-medium">
						<label class="cart-label">Quantity <span class="required">*</span></label>
						<SfNumericTextBox @bind-Value="_selectedRawMaterialQuantity" TValue="decimal" Min="0"
							ShowSpinButton="false" Placeholder="0.00" FloatLabelType="FloatLabelType.Never"
							CssClass="custom-numeric editable-field" />
					</div>

					<div class="cart-field cart-field-button">
						<label class="cart-label" style="visibility: hidden;">Action</label>
						<button class="btn-add" @onclick="AddItemToCart" disabled="@_isProcessing">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
								stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<line x1="12" y1="5" x2="12" y2="19" />
								<line x1="5" y1="12" x2="19" y2="12" />
							</svg>
							<span>Add</span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Recipe Items Grid Section -->
		<div class="section-card">
			<div class="section-header">
				<div class="section-title-wrapper">
					<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
						fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M3 3h7a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H3V3z" />
						<path d="M14 3h7v17h-7V3z" />
					</svg>
					<h2 class="section-title">Recipe Items</h2>
				</div>
			</div>
			<div class="section-body grid-body">
				<SfGrid ID="_sfCartGrid" @ref="_sfCartGrid" DataSource="_recipeItems" AllowTextWrap="true"
					AllowPaging="false" AllowSorting="true" AllowResizing="true" AllowFiltering="true"
					GridLines="GridLine.Horizontal" CssClass="professional-grid"
					Toolbar="@(new List<string>() { "Search" })">

					<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

					<GridAggregates>
						<GridAggregate>
							<GridAggregateColumns>
								<GridAggregateColumn Field="@nameof(RecipeItemCartModel.ItemName)"
									Type="AggregateType.Count">
									<FooterTemplate>
										@{
											var aggregate = (context as AggregateTemplateContext);
										}
										<div class="aggregate-label">
											<strong>Total Items: @aggregate.Count</strong>
										</div>
									</FooterTemplate>
								</GridAggregateColumn>
								<GridAggregateColumn Field="@nameof(RecipeItemCartModel.Quantity)" Type="AggregateType.Sum">
									<FooterTemplate>
										@{
											var aggregate = (context as AggregateTemplateContext);
											var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
										}
										<div class="aggregate-value">
											<strong>@sum.ToString("N2")</strong>
										</div>
									</FooterTemplate>
								</GridAggregateColumn>
							</GridAggregateColumns>
						</GridAggregate>
					</GridAggregates>

					<GridColumns>
						<GridColumn HeaderText="Actions" Width="120" TextAlign="TextAlign.Center">
							<Template>
								@{
									var item = (context as RecipeItemCartModel);
								}
								<div class="grid-actions">
									<button class="btn-grid-action btn-edit" title="Edit Item"
										@onclick="@(() => EditCartItem(item))" disabled="@_isProcessing">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
											fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
											stroke-linejoin="round">
											<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
											<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
										</svg>
									</button>
									<button class="btn-grid-action btn-delete" title="Remove Item"
										@onclick="@(() => RemoveItemFromCart(item))" disabled="@_isProcessing">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
											fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
											stroke-linejoin="round">
											<polyline points="3 6 5 6 21 6" />
											<path
												d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
											<line x1="10" y1="11" x2="10" y2="17" />
											<line x1="14" y1="11" x2="14" y2="17" />
										</svg>
									</button>
								</div>
							</Template>
						</GridColumn>
						<GridColumn Field="@nameof(RecipeItemCartModel.ItemName)" HeaderText="Raw Material Name"
							Width="250" />
						<GridColumn Field="@nameof(RecipeItemCartModel.Quantity)" HeaderText="Quantity" Width="150"
							TextAlign="TextAlign.Right" Format="N2" />
					</GridColumns>
				</SfGrid>
			</div>
		</div>
	</div>
}

<SfToast @ref="_sfErrorToast" ID="_sfErrorToast" Title="@_errorTitle" Content="@_errorMessage" Timeout="5000">
	<ToastPosition X="Right" Y="Top" />
	<ToastShowAnimationSettings Effect="ToastEffect.SlideLeftIn" />
	<ToastHideAnimationSettings Effect="ToastEffect.SlideRightOut" />
</SfToast>

<SfToast @ref="_sfSuccessToast" ID="_sfSuccessToast" Title="@_successTitle" Content="@_successMessage" Timeout="5000">
	<ToastPosition X="Right" Y="Top" />
	<ToastShowAnimationSettings Effect="ToastEffect.SlideLeftIn" />
	<ToastHideAnimationSettings Effect="ToastEffect.SlideRightOut" />
</SfToast>

<style>
	* {
		box-sizing: border-box;
	}

	/* Main Container */
	.purchase-container {
		padding: 16px 32px;
		max-width: 1920px;
		margin: 0 auto;
		background: #f8fafc;
		min-height: calc(100vh - 72px);
	}

	/* Section Card Styles */
	.section-card {
		background: #ffffff;
		border-radius: 12px;
		border: 1px solid #e2e8f0;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
		margin-bottom: 16px;
		overflow: hidden;
	}

	.section-header {
		padding: 16px 20px;
		border-bottom: 1px solid #e2e8f0;
		background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
	}

	.section-title-wrapper {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.section-icon {
		color: #3b82f6;
		flex-shrink: 0;
	}

	.section-title {
		font-size: 16px;
		font-weight: 600;
		color: #0f172a;
		margin: 0;
		letter-spacing: -0.2px;
	}

	.section-body {
		padding: 16px 20px;
	}

	.grid-body {
		padding: 0 !important;
	}

	/* Form Grid Layout */
	.form-grid-single {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 16px 20px;
	}

	.form-field {
		display: flex;
		flex-direction: column;
		gap: 6px;
	}

	.form-field-full {
		grid-column: 1 / -1;
	}

	.field-label {
		font-size: 13px;
		font-weight: 600;
		color: #334155;
		letter-spacing: 0.1px;
		display: flex;
		align-items: center;
		gap: 4px;
	}

	.required {
		color: #ef4444;
		font-weight: 700;
	}

	/* Add to Cart Section Styles - Recipe specific (Raw Material + Quantity only) */
	.cart-row {
		display: grid;
		grid-template-columns: 2fr 1.5fr 150px;
		gap: 12px;
		align-items: end;
		margin-bottom: 12px;
	}

	.cart-field {
		display: flex;
		flex-direction: column;
		gap: 4px;
	}

	.cart-field-product {
		/* Raw Material field - 2fr */
	}

	.cart-field-medium {
		/* Quantity field - 1.5fr */
	}

	.cart-field-button {
		/* Add button - 150px */
	}

	.cart-label {
		font-size: 12px;
		font-weight: 600;
		color: #475569;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.cart-label .required {
		color: #dc2626;
		margin-left: 2px;
	}

	::deep .cart-field .e-input-group,
	::deep .cart-field .custom-numeric .e-input-group,
	::deep .cart-field .custom-autocomplete .e-input-group {
		height: 38px;
		background: #eff6ff;
		border: 1px solid #3b82f6;
	}

	::deep .cart-field .e-input-group input,
	::deep .cart-field .custom-numeric .e-input-group input,
	::deep .cart-field .custom-autocomplete .e-input-group input {
		font-size: 14px;
		font-weight: 500;
		color: #1e293b;
		padding: 8px 12px;
	}

	.btn-add {
		height: 38px;
		padding: 0 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 6px;
		background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
		color: #ffffff;
		border: none;
		border-radius: 6px;
		font-weight: 600;
		font-size: 14px;
		cursor: pointer;
		transition: all 0.2s ease;
		box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
		white-space: nowrap;
		width: 100%;
	}

	.btn-add:hover {
		transform: translateY(-1px);
		box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
	}

	.btn-add:active {
		transform: scale(0.98);
	}

	.btn-add:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.btn-add svg {
		flex-shrink: 0;
	}

	/* Syncfusion Component Overrides */
	::deep .custom-autocomplete,
	::deep .custom-numeric {
		width: 100%;
	}

	::deep .custom-autocomplete .e-input-group,
	::deep .custom-numeric .e-input-group {
		border: 1px solid #cbd5e1;
		border-radius: 6px;
		background: #ffffff;
		transition: all 0.2s ease;
		height: 40px;
	}

	::deep .custom-autocomplete .e-input-group:hover,
	::deep .custom-numeric .e-input-group:not(.e-disabled):hover {
		border-color: #94a3b8;
	}

	::deep .custom-autocomplete .e-input-group.e-input-focus,
	::deep .custom-numeric .e-input-group.e-input-focus {
		border-color: #3b82f6;
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	::deep .custom-autocomplete .e-input-group input,
	::deep .custom-numeric .e-input-group input {
		font-size: 14px;
		color: #1e293b;
		padding: 8px 12px;
	}

	::deep .custom-autocomplete .e-input-group input::placeholder,
	::deep .custom-numeric .e-input-group input::placeholder {
		color: #94a3b8;
	}

	::deep .editable-field .e-input-group {
		border-color: #3b82f6;
		background: #eff6ff;
	}

	::deep .editable-field .e-input-group input {
		font-weight: 600;
		color: #1e40af;
	}

	/* Professional Grid Styles */
	.e-grid .e-summaryrow .e-summarycell {
		background-color: #deecf9;
	}

	::deep .professional-grid {
		border: none;
	}

	::deep .professional-grid .e-gridheader {
		background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
		border-bottom: 2px solid #e2e8f0;
	}

	::deep .professional-grid .e-headercell {
		background: transparent;
		color: #475569;
		font-weight: 600;
		font-size: 12px;
		text-transform: uppercase;
		letter-spacing: 0.3px;
		border-right: 1px solid #e2e8f0;
		padding: 12px 8px;
	}

	::deep .professional-grid .e-headercell:last-child {
		border-right: none;
	}

	::deep .professional-grid .e-gridcontent {
		background: #ffffff;
	}

	::deep .professional-grid .e-row {
		transition: background-color 0.2s ease;
	}

	::deep .professional-grid .e-row:hover {
		background-color: #f8fafc;
	}

	::deep .professional-grid .e-row.e-altrow {
		background-color: #fafbfc;
	}

	::deep .professional-grid .e-row.e-altrow:hover {
		background-color: #f8fafc;
	}

	::deep .professional-grid .e-rowcell {
		border-right: 1px solid #f1f5f9;
		border-bottom: 1px solid #f1f5f9;
		padding: 10px 8px;
		font-size: 13px;
		color: #1e293b;
	}

	::deep .professional-grid .e-rowcell:last-child {
		border-right: none;
	}

	/* Grid Footer Aggregates */
	::deep .professional-grid .e-gridfooter {
		background: linear-gradient(to bottom, #f1f5f9 0%, #e2e8f0 100%);
		border-top: 2px solid #cbd5e1;
	}

	::deep .professional-grid .e-summarycell {
		font-weight: 600;
		color: #1e293b;
		padding: 12px 8px;
		border-right: 1px solid #cbd5e1;
	}

	::deep .professional-grid .e-summarycell:last-child {
		border-right: none;
	}

	.aggregate-label {
		text-align: left;
		font-size: 13px;
		color: #475569;
	}

	.aggregate-value {
		text-align: right;
		font-size: 13px;
		color: #1e293b;
	}

	.aggregate-label strong,
	.aggregate-value strong {
		font-weight: 700;
	}

	.grid-actions {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 6px;
	}

	.btn-grid-action {
		width: 32px;
		height: 32px;
		display: flex;
		align-items: center;
		justify-content: center;
		border: 1px solid #e2e8f0;
		background: #ffffff;
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s ease;
		padding: 0;
	}

	.btn-grid-action:hover {
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.btn-grid-action:active {
		transform: scale(0.95);
	}

	.btn-grid-action:disabled {
		opacity: 0.4;
		cursor: not-allowed;
	}

	.btn-grid-action.btn-edit {
		color: #3b82f6;
		border-color: #3b82f6;
	}

	.btn-grid-action.btn-edit:hover:not(:disabled) {
		background: #eff6ff;
		box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
	}

	.btn-grid-action.btn-delete {
		color: #dc2626;
		border-color: #dc2626;
	}

	.btn-grid-action.btn-delete:hover:not(:disabled) {
		background: #fef2f2;
		box-shadow: 0 2px 6px rgba(220, 38, 38, 0.2);
	}

	/* Empty Grid State */
	::deep .professional-grid .e-emptyrow {
		text-align: center;
		padding: 48px 24px;
		color: #94a3b8;
		font-size: 14px;
	}

	/* Responsive Design */
	@@media (max-width: 1400px) {
		.page-header {
			grid-template-columns: 1fr;
			gap: 16px;
		}

		.header-left {
			justify-content: center;
		}

		.header-center {
			order: -1;
		}

		.header-right {
			justify-content: center;
		}

		.cart-row {
			grid-template-columns: 1fr;
		}

		.form-grid-single {
			grid-template-columns: 1fr;
		}
	}

	@@media (max-width: 768px) {
		.purchase-container {
			padding: 12px 16px;
		}

		.section-body {
			padding: 12px 16px;
		}

		.page-header {
			padding: 12px 16px;
		}
	}
</style>